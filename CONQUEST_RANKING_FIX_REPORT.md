# 占領戦ランキング修正完了報告

## 問題の概要

### 報告された問題
1. 占領戦で、順位を神城の累計占領時間順にしたはずですが、現在もなお城の保有数が優先されてしまっています
2. 将来的にマップを広げることもできるか確認してください。定数の部分を変えるだけで良いですか？

## 修正内容

### 1. ランキングアルゴリズムの修正 ✅

#### 問題の原因
以前のORDER BY句：
```sql
ORDER BY 
    CASE WHEN COALESCE(csot.total_occupation_seconds, 0) > 0 
        THEN 0 ELSE 1 END,
    COALESCE(csot.total_occupation_seconds, 0) DESC,
    COUNT(*) DESC
```

このクエリは以下のように動作していました：
1. 神城累計占領時間 > 0 のグループ（優先度0）
2. 神城累計占領時間 = 0 のグループ（優先度1）
3. 各グループ内で占領時間順、次に城数順

**問題点**: グループが分かれているため、占領時間0のプレイヤーは、どれだけ城を持っていても占領時間が1秒でもあるプレイヤーより下位になる。しかし、グループ内では城数が影響していた。

#### 修正後のORDER BY句
```sql
ORDER BY 
    COALESCE(csot.total_occupation_seconds, 0) DESC,
    COUNT(*) DESC
```

修正後の動作：
1. **全プレイヤー**を神城累計占領時間の降順でソート
2. 占領時間が同じ場合**のみ**、城数でソート

#### 修正箇所
1. `conquest_api.php` の `distributeSeasonRewards()` 関数（462-479行）
2. `conquest_api.php` の `get_ranking` アクション（1717-1742行）

#### UI更新
`conquest.php` のルール表示を更新：

**変更前**:
```html
<li>神城の累計占領時間が0のプレイヤーは保有城数で順位が決まります</li>
```

**変更後**:
```html
<li><strong style="color: #ffd700;">累計占領時間が同じ場合は保有城数で順位が決まります</strong></li>
```

これにより、ルールがより明確になり、実装と一致します。

### 2. マップ拡張の確認 ✅

#### 回答: はい、定数を変えるだけで拡張できます

マップサイズは `CONQUEST_MAP_SIZE` 定数で制御されています：

```php
define('CONQUEST_MAP_SIZE', 5);  // 現在: 5x5 (25城)
```

この定数を変更するだけで、以下が自動的に調整されます：

1. **城の配置**
   - 中心座標: `floor($size / 2)` で自動計算
   - 同心円状の配置（中心からの距離で城タイプを決定）

2. **城の種類**
   - 距離 0: 神城（1つ）
   - 距離 1: 内周城
   - 距離 = maxDistance: 外周城
   - その他: 中間城

3. **隣接関係**
   - 8方向（上下左右＋斜め）の隣接を自動計算

4. **フロントエンドの表示**
   - グリッドレイアウトが自動調整

#### 詳細ドキュメント
`MAP_EXPANSION_GUIDE.md` に詳細なガイドを作成しました：
- サポートされるマップサイズ
- 推奨される設定
- 考慮すべき点（パフォーマンス、ゲームバランスなど）
- 段階的な拡張手順

## 動作確認

### 構文チェック
```bash
php -l conquest_api.php  # No syntax errors
php -l conquest.php      # No syntax errors
```

### ランキングの動作
修正後のランキングは以下のように動作します：

**例1: 占領時間がある場合**
| プレイヤー | 占領時間 | 城数 | 順位 |
|-----------|---------|-----|-----|
| A         | 1000秒  | 5   | 1位 |
| B         | 800秒   | 10  | 2位 |
| C         | 800秒   | 8   | 3位 |
| D         | 0秒     | 15  | 4位 |

**例2: 占領時間が同じ場合**
| プレイヤー | 占領時間 | 城数 | 順位 |
|-----------|---------|-----|-----|
| A         | 500秒   | 10  | 1位 |
| B         | 500秒   | 8   | 2位 |
| C         | 0秒     | 12  | 3位 |
| D         | 0秒     | 10  | 4位 |

## 影響範囲

### 修正されたファイル
1. `conquest_api.php` - ランキングロジック
2. `conquest.php` - UI表示テキスト

### 新規追加ファイル
1. `MAP_EXPANSION_GUIDE.md` - マップ拡張ガイド

### データベース
- スキーマ変更なし
- 既存データへの影響なし

## 今後の推奨事項

### 1. マップ拡張を行う場合
1. テスト環境で動作確認
2. 新シーズンから適用（既存シーズン中の変更は避ける）
3. シーズン期間の調整を検討（マップが大きい場合）
4. ゲームバランスのモニタリング

### 2. 段階的な拡張
- 5x5 → 7x7 → 9x9 のように段階的に
- 各サイズでプレイヤーの反応を確認
- 必要に応じてNPC防御力やシーズン期間を調整

## まとめ

✅ **問題1**: ランキングアルゴリズムを修正し、神城累計占領時間を最優先にしました
✅ **問題2**: マップは `CONQUEST_MAP_SIZE` 定数を変えるだけで拡張できることを確認し、詳細ガイドを作成しました

すべての変更は後方互換性を保ち、既存のデータやゲームプレイに影響を与えません。
