# バトルエンジン更新 2026 - 新スキル対応

## 概要
新規追加された12種類のスキルをバトルエンジンに実装しました。条件付きスキル、デバフスキル、特殊スキルのすべてが正しく機能します。

## 実装されたスキル

### 1. 条件付き攻撃力上昇スキル

#### 対空掃射 (anti_air_barrage)
- **効果**: 相手に空カテゴリがいる場合、攻撃力40%アップ
- **発動率**: 100%
- **実装箇所**: `calculateDamage()` 関数内
- **処理**: 防御側の `domain_categories` に 'air' が含まれているかチェック

#### 戦車駆逐 (tank_destroyer)
- **効果**: 相手に陸カテゴリかつ騎兵カテゴリがいる場合、攻撃力40%アップ
- **発動率**: 100%
- **実装箇所**: `calculateDamage()` 関数内
- **処理**: 防御側の各兵種について `domain_category='land'` かつ `category='cavalry'` をチェック

### 2. デバフスキル

#### 武装解除 (disarm)
- **効果**: 敵の攻撃力を50%低下
- **実装箇所**: `calculateDamage()` 関数内の攻撃力調整セクション

#### 弱体化 (weaken)
- **効果**: 敵の攻撃力と防御力を25%低下
- **実装箇所**: `calculateDamage()` 関数内の攻撃力・防御力調整セクション

### 3. バフスキル

#### 防御陣形 (defense_formation)
- **効果**: 防御力を40%上昇
- **実装箇所**: `calculateDamage()` 関数内の防御力調整セクション

#### 精密射撃 (precision_shot)
- **効果**: クリティカル率を大幅上昇
- **実装箇所**: `calculateDamage()` 関数内のクリティカル判定セクション

#### 鼓舞 (inspire)
- **効果**: 味方全体の攻撃力を30%上昇
- **実装箇所**: `tryActivateSkill()` 関数内、buff型として処理

### 4. 特殊防御スキル

#### 回避 (evasion)
- **効果**: 35%の確率で敵の攻撃を回避
- **実装箇所**: ダメージ計算前に回避判定を追加
- **処理**: 攻撃を完全に無効化（ダメージ0）

#### 反撃 (counter)
- **効果**: ダメージを受けた時に30%の確率で反撃
- **実装箇所**: ダメージ適用後に反撃判定を追加
- **処理**: 受けたダメージの30%を相手に与える

## コード変更箇所

### 1. calculateDamage() 関数の更新
```php
function calculateDamage($baseAttack, $targetArmor, $attackerEffects = [], $defenderEffects = [], $defenderData = null)
```
- 第5引数に `$defenderData` を追加（カテゴリチェック用）
- 対空掃射と戦車駆逐の条件判定ロジックを追加
- 新スキル（disarm, weaken, defense_formation, precision_shot）の処理を追加

### 2. tryActivateSkill() 関数の更新
- counter, evasion, inspire スキルの effect_type を設定
- 各スキルの発動メッセージを追加

### 3. バトルループの更新（2箇所）
- 攻撃側のターン（1107行目付近）
- 防御側のターン（1307行目付近）

#### 追加された処理順序:
1. **回避チェック**: 攻撃前に回避判定、成功時はダメージ計算をスキップ
2. **ダメージ計算**: 既存の計算ロジック（条件付きスキルを含む）
3. **反撃チェック**: ダメージ後に反撃判定、成功時は反撃ダメージを与える
4. **反射チェック**: 既存の反射ロジック

### 4. 関数呼び出しの更新
calculateDamage() の2つの呼び出し箇所で第5引数を追加:
```php
// 攻撃側のターン
calculateDamage(..., $defender)  // 防御側データを渡す

// 防御側のターン
calculateDamage(..., $attacker)  // 攻撃側データを渡す
```

## テスト推奨項目

### 条件付きスキル
- [ ] 対空ミサイルが空カテゴリ（戦闘機、爆撃機など）に対して攻撃力+40%
- [ ] 対戦車砲兵が陸上騎兵（戦車、騎兵など）に対して攻撃力+40%
- [ ] 条件を満たさない場合はスキル効果が発動しない

### 特殊防御スキル
- [ ] 回避スキルで攻撃を回避できる（35%の確率）
- [ ] 反撃スキルでダメージを返せる（30%の確率）
- [ ] 回避成功時はダメージが0になる

### デバフスキル
- [ ] 武装解除で敵の攻撃力が50%低下
- [ ] 弱体化で敵の攻撃力と防御力が25%低下
- [ ] 複数のデバフが同時に適用される

### バフスキル
- [ ] 防御陣形で防御力が40%上昇
- [ ] 精密射撃でクリティカル率が上昇
- [ ] 鼓舞で攻撃力が30%上昇

## 互換性

- 既存のバトルシステムと完全に互換性あり
- calculateDamage() の第5引数はオプション（nullでも動作）
- 既存のスキルに影響なし

## パフォーマンス

- カテゴリチェックは条件付きスキルが発動した場合のみ実行
- 回避・反撃チェックは効果が有効な場合のみ実行
- 大きなパフォーマンス影響なし

## 備考

- すべてのスキルは既存のバトルログシステムと統合されています
- スキル発動時には適切なメッセージが表示されます
- エフェクトはターン制で管理され、duration_turns に従って自動的に消滅します
