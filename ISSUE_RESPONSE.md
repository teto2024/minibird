# 文明育成ゲーム 問題報告と修正完了報告

## 質問への回答

### Q: ルネサンス時代で薬草やガラスなどといった産物が生産できないのは仕様ですか？

**A: いいえ、仕様ではありません。これはバグです。**

薬草とガラスは本来、それぞれの建物（薬草園とガラス工房）から生産されるべき資源でしたが、データベースの設定ミスにより生産されない状態になっていました。

## 問題の詳細

### 影響を受ける資源と建物

| 資源 | アイコン | 建物 | アンロック時代 | 状態 |
|-----|---------|-----|--------------|------|
| 薬草 | 🌿 | 薬草園 | 青銅器時代 | ❌ 生産不可 |
| ガラス | 🔮 | ガラス工房 | 中世 | ❌ 生産不可 |
| 布 | 🧵 | 織物工場 | 青銅器時代 | ❌ 生産不可 |
| クリスタル | 💎 | クリスタル鉱山 | ルネサンス | ❌ 生産不可 |
| 医薬品 | 💊 | 調剤所 | 中世 | ❌ 生産不可 |
| 鋼鉄 | ⚙️ | 製鋼所 | ルネサンス | ❌ 生産不可 |
| 火薬 | 💥 | 火薬工場 | ルネサンス | ❌ 生産不可 |
| 電子部品 | 🔌 | 電子部品工場 | 現代 | ❌ 生産不可 |

### 技術的な原因

データベーステーブル `civilization_building_types` において、これらの建物の `produces_resource_id` カラムが `NULL` に設定されていました。

```sql
-- 問題のある設定例
INSERT INTO civilization_building_types (..., produces_resource_id, production_rate, ...)
VALUES ('glassworks', 'ガラス工房', ..., NULL, 0, ...);
                                        ↑
                                     ここがNULL
```

資源生産システムは `produces_resource_id` を参照して資源を生成するため、`NULL` の場合は何も生産されません。

## 修正内容

### 実装した修正

1. **SQLマイグレーションスクリプト作成** (`fix_resource_production.sql`)
   - 全ての問題のある建物の `produces_resource_id` を正しく設定
   - 適切な `production_rate`（生産速度）を設定
   - 建物カテゴリを `special` から `production` に変更

2. **修正後の生産速度**

| 建物 | 資源 | 生産速度（/時） | 理由 |
|-----|-----|----------------|------|
| 薬草園 | 薬草 | 8.0 | 基本的な材料資源 |
| ガラス工房 | ガラス | 4.0 | やや希少な加工資源 |
| 織物工場 | 布 | 6.0 | 基本的な加工資源 |
| クリスタル鉱山 | クリスタル | 1.0 | 非常に希少な資源 |
| 調剤所 | 医薬品 | 3.0 | 高度な加工資源 |
| 製鋼所 | 鋼鉄 | 3.0 | 高度な金属資源 |
| 火薬工場 | 火薬 | 2.0 | 危険な加工資源 |
| 電子部品工場 | 電子部品 | 1.5 | 最先端の資源 |

### 修正の適用方法

```bash
# MySQLにログインして実行
mysql -u root -p microblog < fix_resource_production.sql
```

## 完全な仕様書の作成

### 作成したドキュメント

1. **CIVILIZATION_GAME_SPECIFICATION.md** - ゲームの完全仕様書
   - ゲームシステムの概要
   - 全7時代の詳細（石器時代〜現代）
   - 全28種類の資源リスト
   - 全建物カテゴリと個別建物の説明
   - 全43種類の研究ツリー
   - 兵種システムと相性
   - 戦闘システムの仕組み
   - 訓練・治療キューシステム
   - 市場での資源交換
   - VIPショップ
   - 占領戦システム
   - ゲームバランス定数
   - 技術仕様
   
2. **RESOURCE_PRODUCTION_FIX_README.md** - 修正内容の詳細説明
   - 問題の詳細
   - 修正方法
   - 適用手順
   - トラブルシューティング

3. **fix_resource_production.sql** - データベース修正スクリプト
   - 即座に適用可能
   - 確認クエリ付き

## ゲームシステムの概要（仕様書より抜粋）

### 基本的なゲームの流れ

1. **コイン投資** 
   - 10コイン = 1研究ポイント + 基本資源ボーナス
   
2. **資源生産**
   - 建物が時間経過で自動的に資源を生産
   - 生産量 = 基本生産率 × 建物レベル × 時間
   
3. **建物建設**
   - 資源とコインを消費して建設
   - 建設には時間がかかる（クリスタル/ダイヤで即完了可能）
   
4. **研究**
   - 研究ポイントを使って新技術を開発
   - 新しい建物や資源をアンロック
   
5. **時代進化**
   - 人口と研究ポイントの条件を満たすと次の時代へ
   - 新しい建物、資源、兵種がアンロックされる

### 7つの時代

1. **石器時代** (🪨) - 人口0、研究0から開始
2. **青銅器時代** (🔶) - 人口50、研究100で進化
3. **鉄器時代** (⚔️) - 人口200、研究500で進化
4. **中世** (🏰) - 人口500、研究1500で進化
5. **ルネサンス** (🎨) - 人口1000、研究4000で進化
6. **産業革命** (🏭) - 人口2500、研究10000で進化
7. **現代** (🌆) - 人口5000、研究25000で進化

### 資源の種類

#### 基本資源（石器時代〜）
- 食料 (🍖) - 住民を養う
- 木材 (🪵) - 建設に必要
- 石材 (🪨) - 頑丈な建物に必要

#### 金属資源
- 青銅 (🔶) - 青銅器時代
- 鉄 (⚙️) - 鉄器時代
- 金 (💰) - 中世
- 鋼鉄 (⚙️) - ルネサンス

#### 加工資源
- 布 (🧵) - 青銅器時代
- ガラス (🔮) - 中世
- 医薬品 (💊) - 中世
- 火薬 (💥) - ルネサンス

#### 希少資源
- クリスタル (💎) - ルネサンス
- ウラン (☢️) - 現代
- ダイヤモンド (💠) - 現代

### 戦闘システム

#### 兵種の相性
- **歩兵** → 遠距離に強い、騎兵に弱い
- **騎兵** → 歩兵に強い、遠距離に弱い
- **遠距離** → 騎兵に強い、歩兵に弱い
- **攻城** → 歩兵に強い、騎兵に弱い

相性ボーナス: 有利+25% / 不利-25%

#### ターン制バトル
1. 両軍の初期HPを設定
2. 攻撃側と防御側が交互に攻撃
3. ダメージ = 攻撃力 × (1 - 敵アーマー軽減) × 相性倍率
4. どちらかのHPが0になるまで継続

#### 装備バフ
- **攻撃力**: 直接戦闘力に加算
- **アーマー**: 最大50%まで敵の攻撃を軽減
- **体力**: 戦闘継続力に影響

## 今後の推奨事項

### 1. データの整合性チェック
他にも同様の問題がないか、全建物と資源の関係を確認することをお勧めします。

### 2. テストの追加
資源生産が正常に動作することを確認する自動テストの追加を推奨します。

### 3. 既存プレイヤーへの補償
修正前に該当建物を建設していたプレイヤーには、適切な量の資源を補償として付与することを検討してください。

## 関連ファイル

- `CIVILIZATION_GAME_SPECIFICATION.md` - 完全な仕様書
- `RESOURCE_PRODUCTION_FIX_README.md` - 修正の詳細説明
- `fix_resource_production.sql` - データベース修正スクリプト
- `civilization_schema.sql` - 基本スキーマ
- `civilization_enhancements_schema.sql` - 拡張スキーマ（薬草、ガラスを含む）
- `war_system_advanced_schema.sql` - 戦闘システム拡張（医薬品を含む）
- `civilization_api.php` - バックエンドAPI
- `civilization.php` - フロントエンド

## まとめ

**質問への最終回答:**

> ルネサンス時代で薬草やガラスなどといった産物が生産できないのは仕様ですか？

**いいえ、バグです。** 修正スクリプト (`fix_resource_production.sql`) を適用することで、薬草、ガラス、その他の特殊資源が正常に生産されるようになります。

また、ゲームの詳しい中身については、`CIVILIZATION_GAME_SPECIFICATION.md` に完全な仕様書としてまとめました。このドキュメントには、全ての時代、資源、建物、研究、兵種、戦闘システムの詳細が記載されています。

---

**作成日**: 2024年12月29日  
**バージョン**: 1.0  
**ステータス**: ✅ 修正完了、テスト待ち
