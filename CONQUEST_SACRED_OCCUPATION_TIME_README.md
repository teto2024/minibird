# 占領戦 神城累計占領時間トラッキング機能

## 概要
占領戦システムに神城の累計占領時間を記録する機能を追加し、ランキングアルゴリズムを変更しました。

## 主な変更点

### 1. データベース変更
- `conquest_sacred_occupation_time` テーブルを新規作成
  - `season_id`: シーズンID
  - `user_id`: ユーザーID
  - `total_occupation_seconds`: 神城の累計占領時間（秒）
  - `last_occupation_start`: 最後に神城を占領した時刻

- `conquest_castles` テーブルに新規カラム追加
  - `sacred_occupation_started_at`: 神城が占領された時刻

- `conquest_season_rewards` テーブルに新規カラム追加
  - `sacred_occupation_seconds`: 神城の累計占領時間（秒）

### 2. ランキングアルゴリズムの変更

#### 変更前
- 最後まで神城を持っていたプレイヤーが優勝
- それ以外は城数順

#### 変更後
- **神城の累計占領時間が最も長いプレイヤーが優勝**
- 神城の累計占領時間が同じ場合は、その時間の長い順
- 神城の累計占領時間が0のプレイヤーは、保有城数順で決定

### 3. フロントエンド変更

#### ランキング表示
- 神城の累計占領時間を表示（時間・分形式）
- 現在神城を占領しているプレイヤーは、リアルタイムで占領時間が加算される

#### 報酬表の追加
順位に応じた報酬を動的に表示：
- 1位: コイン 1,000,000 / クリスタル 1,000 / ダイヤモンド 100
- 2位: コイン 500,000 / クリスタル 500 / ダイヤモンド 50
- 3位: コイン 300,000 / クリスタル 300 / ダイヤモンド 30
- 4-10位: コイン 100,000 / クリスタル 100 / ダイヤモンド 10
- 11位以下: コイン 5,000 / クリスタル 5 / ダイヤモンド 1

#### ルール表記の更新
- 「中央の神城⛩️を占領すると占領時間が記録されます」
- 「シーズン終了時、神城の累計占領時間が最も長いプレイヤーが優勝」
- 「神城の累計占領時間が0のプレイヤーは保有城数で順位が決まります」

## 技術的な実装詳細

### 占領時間トラッキングの仕組み

1. **神城占領時**
   - `updateSacredOccupationTime()` 関数が呼ばれる
   - 前の所有者の占領時間を計算し、累計に加算
   - 新しい所有者の占領開始時刻を記録

2. **神城喪失時**
   - 砲撃で耐久度が0になった場合も同様に処理
   - 前の所有者の占領時間を累計に加算

3. **シーズン終了時**
   - `finalizeSacredOccupationTimes()` 関数で最終更新
   - 現在神城を占領しているプレイヤーの占領時間を最終加算

### CRONジョブ不要の設計
- ページアクセス時にリアルタイムで占領時間を計算
- データベースには累計占領時間のみを保存
- 現在の占領時間は `NOW() - sacred_occupation_started_at` で動的に計算

## スキーマ適用方法

```bash
mysql -u root microblog < conquest_sacred_occupation_time_schema.sql
```

## 注意事項

- user_id は INT 型であることに注意
- 既存のデータベース構造を活用し、最小限の変更で実装
- 砲撃システムとも連携し、神城が陥落した場合も正しく占領時間を記録
