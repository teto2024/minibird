# 占領戦システム強化 - 実装完了報告

## 実装概要

MiniBirdの占領戦システムに以下の機能を追加し、ランキングアルゴリズムを変更しました。

## 実装内容

### 1. 神城の累計占領時間記録システム ✅
- **新規テーブル**: `conquest_sacred_occupation_time`
  - プレイヤーごとに神城の累計占領時間を記録
  - シーズンごとに管理
- **追跡メカニズム**: 
  - 神城を占領した時に開始時刻を記録
  - 神城を失った時に累計時間を更新
  - シーズン終了時に最終集計

### 2. ランキングアルゴリズムの変更 ✅

#### 変更前
```
順位 = 神城所有（最後まで持っていた人が1位） > 城数
```

#### 変更後
```
順位 = 神城累計占領時間（降順） > 城数（降順）
※ 神城累計占領時間が0の場合のみ城数で比較
```

### 3. UI/UX改善 ✅

#### ランキング表示
- 神城累計占領時間を「X時間Y分」形式で表示
- 現在神城を占領中のプレイヤーは、リアルタイムで時間が加算される表示
- 神城マーク（⛩️）で視覚的にわかりやすく

#### 報酬テーブル表示
- シーズン報酬を動的に表示（APIから取得）
- 5段階の報酬テーブル:
  - 1位: 💰100,000 / 💎1,000 / 💠100
  - 2位: 💰50,000 / 💎500 / 💠50
  - 3位: 💰30,000 / 💎300 / 💠30
  - 4-10位: 💰10,000 / 💎100 / 💠10
  - 11位以下: 💰500 / 💎5 / 💠1

#### ルール表記の更新
- 新しいランキングシステムをわかりやすく説明
- 神城の重要性を強調
- 戦略的要素の説明を追加

## 技術仕様

### データベース設計

#### 新規テーブル: conquest_sacred_occupation_time
```sql
CREATE TABLE conquest_sacred_occupation_time (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    season_id INT UNSIGNED NOT NULL,
    user_id INT UNSIGNED NOT NULL,
    total_occupation_seconds BIGINT UNSIGNED NOT NULL DEFAULT 0,
    last_occupation_start DATETIME NULL,
    UNIQUE KEY (season_id, user_id)
);
```

#### 追加カラム
- `conquest_castles.sacred_occupation_started_at`: 神城占領開始時刻
- `conquest_season_rewards.sacred_occupation_seconds`: 報酬記録用

### API エンドポイント

#### `get_ranking` (更新)
- 神城累計占領時間を含むランキングを返す
- 現在占領中のプレイヤーは、リアルタイムで占領時間を加算して返す

#### `get_rewards` (新規)
- 報酬テーブルをJSON形式で返す
- バックエンドの定数と完全同期

### 主要関数

#### `updateSacredOccupationTime($pdo, $seasonId, $oldOwnerId, $newOwnerId)`
- 神城の所有者変更時に累計占領時間を更新
- 前の所有者の占領時間を計算して累計に加算
- 新しい所有者の占領開始時刻を記録

#### `finalizeSacredOccupationTimes($pdo, $seasonId)`
- シーズン終了時に全プレイヤーの占領時間を最終更新
- 現在神城を占領しているプレイヤーの占領時間を累計に加算

#### `distributeSeasonRewards($pdo, $seasonId)` (更新)
- 新しいランキングアルゴリズムで報酬を配布
- 神城累計占領時間順にソート（0の場合は城数順）

## 実装のポイント

### ✅ CRONジョブ不要
- ページアクセス時にリアルタイムで占領時間を計算
- データベースには累計時間のみを保存
- 現在の占領時間は `NOW() - sacred_occupation_started_at` で動的に計算

### ✅ 既存DB構造を活用
- 最小限のカラム追加
- 既存のテーブル構造を維持
- 後方互換性を保持

### ✅ エッジケース対応
- 砲撃で神城が陥落した場合も正しく占領時間を記録
- NPCが城を持っている場合の処理
- シーズン途中での神城所有者変更に対応

### ✅ パフォーマンス最適化
- フロントエンドは `Promise.all` で並列API取得
- データベースクエリは効率的なJOINとインデックス活用
- リアルタイム計算は必要な時のみ実行

## デプロイ手順

### 1. データベーススキーマ適用
```bash
mysql -u root microblog < conquest_sacred_occupation_time_schema.sql
```

### 2. ファイルをデプロイ
- `conquest_api.php` (更新)
- `conquest.php` (更新)
- `conquest_sacred_occupation_time_schema.sql` (新規)

### 3. 動作確認
- ランキング表示が正しく表示されること
- 報酬テーブルが表示されること
- 神城を占領した時に占領時間が記録されること
- シーズン終了時に正しく報酬が配布されること

## テスト項目

- [ ] 神城を占領した時に `sacred_occupation_started_at` が記録される
- [ ] 神城を失った時に累計占領時間が更新される
- [ ] ランキングが神城累計占領時間順になっている
- [ ] 現在神城を占領中のプレイヤーの占領時間がリアルタイムで表示される
- [ ] 報酬テーブルがAPIから正しく取得される
- [ ] シーズン終了時に報酬が正しく配布される
- [ ] 砲撃で神城が陥落した時も占領時間が正しく記録される

## 今後の拡張案

1. **占領時間ランキングの詳細表示**
   - 過去のシーズンの占領時間も表示
   - プレイヤーごとの占領時間履歴

2. **リアルタイム通知**
   - 神城が占領された時の通知
   - 占領時間のマイルストーン達成通知

3. **戦略的要素の追加**
   - 神城の占領時間に応じたボーナス
   - 長期占領に対する追加報酬

## まとめ

すべての要件を実装し、コードレビューの指摘も対応しました。
- ✅ 神城の累計占領時間を記録
- ✅ 占領戦の順位決めのアルゴリズムを変更
- ✅ 順位表に神城の累計占領時間を記載
- ✅ 報酬表も記載（報酬定義に応じて動的に変動）
- ✅ 各ルール表記も変更
- ✅ CRONジョブを使わない実装
- ✅ user id は INT 型対応
- ✅ 既存のDB構造を活用
