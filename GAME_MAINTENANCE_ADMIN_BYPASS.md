# ゲームメンテナンスモード - 管理者バイパス機能

## 概要

ゲームメンテナンスモード中でも、管理者（`role='admin'`）は全てのゲーム機能にアクセスできるようになりました。

## 実装内容

### 変更ファイル
- `config.php`: `check_game_maintenance()` 関数を更新

### 動作

#### 通常ユーザー
```
メンテナンスモードON → ゲーム機能にアクセス不可
メンテナンスモードOFF → ゲーム機能にアクセス可能
```

#### 管理者ユーザー（role='admin'）
```
メンテナンスモードON → ゲーム機能にアクセス可能（バイパス）
メンテナンスモードOFF → ゲーム機能にアクセス可能
```

### コード変更詳細

```php
function check_game_maintenance($exitOnMaintenance = true) {
    if (GAME_MAINTENANCE_MODE) {
        // 管理者はメンテナンスモードをバイパス
        $currentUser = user();
        if ($currentUser && isset($currentUser['role']) && $currentUser['role'] === 'admin') {
            return false; // 管理者にはメンテナンス中と見なさない
        }
        
        // 通常ユーザーはメンテナンスエラーを返す
        if ($exitOnMaintenance) {
            echo json_encode([
                'ok' => false,
                'error' => 'maintenance',
                'maintenance' => true,
                'message' => GAME_MAINTENANCE_MESSAGE
            ]);
            exit;
        }
        return true;
    }
    return false;
}
```

## 使用ケース

### 1. メンテナンス中のテスト
管理者がメンテナンス中でもゲーム機能をテストできます。

**手順**:
1. 管理者としてログイン
2. メンテナンスモードを有効化
3. 通常通りゲーム機能にアクセスして動作確認
4. 問題なければメンテナンスモードを解除

### 2. データ修正作業
メンテナンス中にデータ修正が必要な場合、管理者がゲームにアクセスして確認できます。

### 3. 緊急対応
ユーザーをブロックしたまま、管理者が問題の原因を調査できます。

## セキュリティ考慮事項

- ✅ `role='admin'` の厳密なチェック
- ✅ セッション経由でのユーザー情報取得（改ざん不可）
- ✅ データベースから直接ロールを取得
- ✅ 管理者のみバイパス可能（他のロールは不可）

## テスト方法

### テストケース1: 管理者がメンテナンスモードをバイパスできる

**前提条件**:
- 管理者アカウントでログイン
- メンテナンスモードを有効化

**手順**:
1. 占領戦ページにアクセス (`conquest.php`)
2. ゲーム機能が正常に動作することを確認
3. メンテナンスオーバーレイが表示されないことを確認

**期待結果**:
- ゲーム機能が正常に動作
- メンテナンスメッセージが表示されない

### テストケース2: 通常ユーザーはメンテナンスモードでブロックされる

**前提条件**:
- 通常ユーザーアカウントでログイン
- メンテナンスモードを有効化

**手順**:
1. 占領戦ページにアクセス (`conquest.php`)
2. メンテナンスオーバーレイが表示されることを確認

**期待結果**:
- メンテナンスオーバーレイが表示される
- ゲーム機能にアクセスできない

### テストケース3: メンテナンスモードOFF時は全員アクセス可能

**前提条件**:
- メンテナンスモードを無効化

**手順**:
1. 管理者・通常ユーザーそれぞれでゲームにアクセス
2. 両方とも正常にアクセスできることを確認

**期待結果**:
- 管理者・通常ユーザー共に正常にアクセス可能

## メンテナンスモードの設定方法

### 方法1: 管理画面から
1. 管理者でログイン
2. 管理画面にアクセス
3. メンテナンスモード設定を変更

### 方法2: maintenance_config.php ファイル
```php
<?php
$maintenance_mode_enabled = true;  // または false
$maintenance_message = 'ゲームシステムはメンテナンス中です。しばらくお待ちください。';
```

### 方法3: 環境変数
```bash
export GAME_MAINTENANCE_MODE=true
export GAME_MAINTENANCE_MESSAGE="メンテナンス中です"
```

## トラブルシューティング

### 問題: 管理者でもメンテナンスモードでブロックされる

**考えられる原因**:
1. ユーザーの `role` が `'admin'` でない
2. セッションが切れている

**確認方法**:
```sql
-- データベースでユーザーのroleを確認
SELECT id, handle, role FROM users WHERE id = <USER_ID>;
```

**解決方法**:
- ユーザーのroleが `'admin'` であることを確認
- 再ログイン

### 問題: メンテナンスモードが解除されない

**解決方法**:
1. `maintenance_config.php` で `$maintenance_mode_enabled = false;` を確認
2. 環境変数 `GAME_MAINTENANCE_MODE` を確認
3. サーバーを再起動

## 関連ファイル

- `config.php`: メンテナンスチェック関数
- `maintenance_config.php`: メンテナンスモード設定ファイル
- `admin_unified.php`: 管理画面（メンテナンスモード設定）
- 各APIファイル: `civilization_api.php`, `conquest_api.php`, `world_boss_api.php` など

## 注意事項

- 管理者バイパスは**ゲームメンテナンスモードのみ**に適用されます
- サイト全体のメンテナンスモードには影響しません
- 管理者は通常ユーザーと同様にゲームルールに従います（特別な権限はありません）
- バイパス機能はテスト・管理目的でのみ使用してください

## 今後の拡張案

1. **メンテナンスモード中でも一部の機能を有効化**
   - 例: 読み取り専用モード、ランキング閲覧のみ可能

2. **メンテナンススケジュール機能**
   - 事前に予定されたメンテナンス時間を設定
   - ユーザーに事前通知

3. **部分的メンテナンスモード**
   - 特定の機能のみメンテナンス中にする
   - 例: 占領戦のみメンテナンス、文明育成は可能
